<html>
<head>
    <title>authentication with Msal.js app</title>
    <style>
        .hidden {
            visibility: hidden
        }

        .visible {
            visibility: visible
        }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js"></script>
    <script src="public/msal.js" class="pre"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" class="pre"></script>
    <h1>Accessing a Web API with msal.js and AAD/B2C</h1>
    <div>
        <div id="label">Sign-in with Microsoft</div>
        <button id="auth" onclick="login();">Login</button>
    </div>
    <div id="callApi" class="hidden">
        <button id="auth" onclick="callApi();">Call Web API</button>
    </div>

    <pre class="response"></pre>

    <script class="pre"> 
        "use strict";
        var applicationConfig = {
            tenantID: 'fabrikamb2c.onmicrosoft.com',                    // Tenant in which the AAD-B2C directory was created "something.onmicrosoft.com""
            clientID: 'e760cab2-b9a1-4c0d-86fb-ff7084abd902',           // ClientID of the application as registered in the AAD-B2C tenant.
            policyName: 'B2C_1_SUSI',                                   // Name of a sign-in sign-up policy added to the AAD-B2C tenant
            redirectUri: 'http://localhost:6420/',                      // Redirect URL for the application. Needs also to be added in the application's properties in B2C
            webApi: 'https://fabrikamb2chello.azurewebsites.net/hello', // Web API to call
            scopes: ['https://fabrikamb2c.onmicrosoft.com/demoapi/demo.read']   // Scope required to access the WebAPI
        }; 

        // authority in the form: "https://login.microsoftonline.com/tfp/<B2C-TenantId>/<B2C-policyName>",
        var authority = "https://login.microsoftonline.com/tfp/" + applicationConfig.tenantID + "/" + applicationConfig.policyName;

    </script>

    <script>
        "use strict";
        var clientApplication = new Msal.UserAgentApplication(applicationConfig.clientID, authority, authenticationCallback);
        clientApplication.redirectUri = applicationConfig.redirectUri;

        // On page load, check if the token is present in the location hash and handle it
        var isCallback = clientApplication.isCallback(window.location.hash);
        if (isCallback) {
            clientApplication.handleAuthenticationResponse(window.location.hash);
        }

        // The authentication callback is needed when we use loginRedirect - for instance IE
        function authenticationCallback(errorDesc, idToken, error) {
            if (idToken) {
                onAuthentication(idToken);
            }
            else {
                log(errorDesc + ':' + error);
            }
        }

        function onAuthentication(idToken) {
            // Change button to Sign Out
            var authButton = document.getElementById('auth');
            authButton.innerHTML = 'logout';
            authButton.setAttribute('onclick', 'logout();');
            var label = document.getElementById('label');
            label.innerText = "Hello " + clientApplication.getUser().name + "! Please press callApi to call the Api";

            // Show the email address part
            var callApiSpan = document.getElementById('callApi');
            callApiSpan.className = "visible";
        }

        function login() {
            clientApplication.loginPopup(applicationConfig.scopes)
                .then(onAuthentication), function(message) {
                    log(message);
                };
        }

        function logout() {
            // Removes all sessions, need to call AAD endpoint to do full logout
            clientApplication.logout();
        }

        function callApi() {
            clientApplication.acquireTokenSilent(applicationConfig.scopes)
                .then(function (token, error) {
                    $.ajax({
                        type: "POST",
                        contentType: "application/json",
                        dataType: 'json',
                        beforeSend: function (request) {
                            request.setRequestHeader('Authorization', 'bearer ' + token);
                        },
                        url: applicationConfig.webApi,
                        data: JSON.stringify({}),
                        processData: false,
                        success: function (msg) {
                            log(msg);
                        }
                    });
                });
        }

        function log(s) {
            document.body.querySelector('.response').appendChild(document.createTextNode("\n\n" + JSON.stringify(s, true, 2)));
        }
    </script>
</body>
</html>